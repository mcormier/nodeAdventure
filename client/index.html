<html>
<head>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="http://mcormier.github.io/js/PPUtils-1.0.0.js"></script>

  <link rel="stylesheet" type="text/css" href="client.css">
</head>
<body>

  <div id="narrative">
    <div id="workarea">

      <div class="startScreen">
      </div>

      <div class="console">
        <div id="cmd">
          <div id="prompt"> &gt; </div>
            <span id="cmd_input"></span>
            <div id="cursor"></div>
        </div>
 
   <!-- 
      &gt; 
        <input id="console" maxlength="40" />
   -->
      </div>

    </div>
  </div>

  <script>

    var local = true;
    var cursorAnim;
    var command_string = "";

    var socket;
    if (local) {
     socket  = io.connect('http://127.0.0.1:8080');
     console.log("Running in local test mode");
    } else  {
      socket = io.connect('http://nodejs-catts.rhcloud.com:8000');
    }

    socket.on('display text', function(msg) {
       console.log("Message from server: " + msg );
       var display = $("workarea");
       var newDiv = document.createElement("div");
       var t = document.createTextNode(msg);
       newDiv.appendChild(t);
       display.appendChild(newDiv);
    });

    // StoryList returned is an array
    socket.on('stories', function (storyList) {
       console.log("Received story list " + storyList);
       // This is a simple client that ignores the storyList and always asks
       // for CATSS
       socket.emit('chooseStory', 'CATSS'); 
       //socket.emit('chooseStory', 'DarkSecret'); 
    });


    // Could push this into an editor class
    function captureKeyInput(e) {
      var input_elem = $("cmd_input");
      //console.log(e.keyCode);

      // Handle control characters first
      if (e.keyCode == 13 ) {
        handleEnter(e);
        return;
      }

      // Handle deletes
      if (e.keyCode == 8 ) { 
        command_string = command_string.substring(0,command_string.length-1);
        input_elem.innerHTML = htmlForString(command_string);
        return; 
      }
    
      // Ignore other control characters, TAB, etc..
      // Only accept A - Z input and SPACE
      if ( ( e.keyCode < 65 || e.keyCode > 90 ) && e.keyCode != 32 ) { return; }
      command_string = command_string + String.fromCharCode(e.keyCode);

      input_elem.innerHTML = htmlForString(command_string);
    }

    function htmlForString(command) {
        return command.replace(/ /g, "&nbsp;");
    }


    function handleEnter(e) {
      if (e.keyCode == 13 ) {
        socket.emit('command', command_string);
        $("cmd_input").innerHTML='';
        command_string = '';
      }
    }

    function toggleCursorVisibility() {
      var elem = $('cursor');
      var opacity = elem.style.opacity;
      if ( opacity == 1 ) {
        elem.style.opacity = 0;
      } else {
        elem.style.opacity = 1;
      }
    }


    //PPUtils.bind('keyup', $("console"), handleEnter);
    PPUtils.bind('keyup', document, captureKeyInput);
    cursoAnim =  window.setInterval( toggleCursorVisibility, 600);

  </script>


</body>
</html>
